## Smoke Test Backend IA — Evidencia para backend

### Resumen (acciones requeridas)
- **Bloqueo 1 (crítico)**: `POST /webapi/chat/openrouter` con `stream:true` devuelve `event:error` con **`AUTH_ERROR`** → falta configurar **`OPENROUTER_API_KEY`** (o whitelabel OpenRouter) en el backend IA.
  - **trace_id**: `f3c722b6`
- **Bloqueo 2 (crítico)**: `POST /webapi/chat/openrouter` con `stream:false` responde `success:true` pero usa **`provider:"ollama"`** (provider distinto al solicitado). Esto rompe el concepto de “enrutador” y provoca UX inconsistente.
- **Esperado**:
  - Para **`openrouter`**: usar OpenRouter (provider=openrouter) y devolver respuesta real.
  - Si no hay key/config: devolver **error estructurado** (`success:false`) y no “success true” con provider alterno.

### Qué necesitamos del backend IA
- Configurar `OPENROUTER_API_KEY` (y/o whitelabel `aiProvider=openrouter` + `aiApiKey`) y reiniciar.
- Garantizar que el router no degrade a `ollama` si el producto “ya no usa ollama”. En su lugar, devolver error claro.
- (Opcional) Añadir `trace_id` también en respuestas JSON `stream:false` cuando haya fallback/error.

- **Base URL**: `https://api-ia.bodasdehoy.com`
- **Development**: `bodasdehoy`
- **Providers**: `openrouter`
- **Model (default)**: `openrouter/auto`
- **RequestId**: `smoke_20260120_193126_29838`
- **Fecha (UTC)**: `2026-01-20T18:31:26Z`

### 1) Health
```
HTTP/2 200 
date: Tue, 20 Jan 2026 18:31:26 GMT
content-type: application/json
content-length: 124
server: cloudflare
cf-cache-status: DYNAMIC
nel: {"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}
report-to: {"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=NZuv%2FS7quXzgedRnHzc9lbKMlLdyQEi5AYY28M5Xv3cTZ%2BYXNVY6kwqrxD06tlJ6C2bWxo0sxlbGAHRZicqv6nWzyqVTzhaWUUmH3ODE0aY6rfnH7g%3D%3D"}]}
cf-ray: 9c10a6163c2304ae-MAD
alt-svc: h3=":443"; ma=86400

{"status":"healthy","timestamp":"2026-01-20T18:31:26.717569","services":{"websockets":"0 active","graphql_proxy":"running"}}```

### 2) Models (openrouter)
```
HTTP/2 200 
date: Tue, 20 Jan 2026 18:31:27 GMT
content-type: application/json
content-length: 740
server: cloudflare
cf-cache-status: DYNAMIC
nel: {"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}
report-to: {"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=%2B69UKeNzMjcN5R%2Fos17VOuemr4rvT0X0DmVlWDynxUcnFYfyqDtTiNsaDSl4KWWNNO2keERpI5%2FpSseXx62y0fnsEqoNNopfcqoh0GwyDYcj7Nc%3D"}]}
cf-ray: 9c10a61969221529-MAD
alt-svc: h3=":443"; ma=86400

{"models":[{"id":"openrouter/auto","name":"Openrouter/Auto","provider":"openrouter","context":128000,"maxOutput":4096},{"id":"anthropic/claude-3.5-sonnet","name":"Claude 3.5 Sonnet","provider":"openrouter","context":128000,"maxOutput":4096},{"id":"openai/gpt-4o","name":"GPT-4","provider":"openrouter","context":128000,"maxOutput":4096},{"id":"google/gemini-pro-1.5","name":"Gemini 1.5 Pro","provider":"openrouter","context":128000,"maxOutput":4096},{"id":"qwen2.5:7b","name":"Qwen 2.5 7B","provider":"ollama","context":128000,"maxOutput":4096},{"id":"llama3.2:3b","name":"Llama 3.2 3B","provider":"ollama","context":128000,"maxOutput":4096},{"id":"phi3:medium","name":"Phi-3 Medium","provider":"ollama","context":128000,"maxOutput":4096}]}```

### 3) Chat (openrouter) stream:false (esperado: JSON)
```
HTTP/2 200 
date: Tue, 20 Jan 2026 18:31:27 GMT
content-type: application/json
content-length: 179
server: cloudflare
cf-cache-status: DYNAMIC
nel: {"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}
report-to: {"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=ba305Dmd9p04fKC8FWSWgOdHKvq734m6R1kn6TW1EbrHm2E%2FDu44oeDXGn7Vwk92BWzcAEovgUp%2FMcHNM0gLLjLsUw70coG57lbVlvaDZ988mALkrg%3D%3D"}]}
cf-ray: 9c10a61baa8912fe-MAD
alt-svc: h3=":443"; ma=86400

{"success":true,"message":"Lo siento, no pude generar una respuesta. Por favor, intenta de nuevo.","metadata":{},"provider":"ollama","model":"qwen2.5:7b","tokens_used":0,"cost":0}```

**Resultado:** ❌ FAIL — el backend respondió con provider distinto a "openrouter".

### 4) Chat (openrouter) stream:true (esperado: SSE sin event:error)
```
HTTP/2 200 
date: Tue, 20 Jan 2026 18:31:28 GMT
content-type: text/event-stream; charset=utf-8
cache-control: no-cache
server: cloudflare
x-model: openrouter/auto
x-provider: openrouter
cf-cache-status: DYNAMIC
nel: {"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}
report-to: {"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=lN5t0bk35bDzDvHwLpnwPhyPXFdHO0gGOtckkACvNyxf23XW9IXsNKNbstzrZynjVp5h%2FtlAYkESrwMbKUOwCjTKRfZGqr6287zo3w9GUfdDkDU%3D"}]}
cf-ray: 9c10a6207f052729-MAD
alt-svc: h3=":443"; ma=86400

event: error
data: {"error": "API key de OpenRouter no configurada y no hay fallback disponible. Por favor, configura OPENROUTER_API_KEY o usa otro provider.", "error_code": "AUTH_ERROR", "trace_id": "f3c722b6", "provider": "openrouter", "model": "openrouter/auto", "upstream_status": null, "timestamp": "2026-01-20T18:31:28.347669", "context": {}}

event: done
data: {}

```

**Resultado:** ❌ FAIL — stream contiene event: error.

### 5) API chat alternativa (/api/chat) (solo para comparar contrato)
```
HTTP/2 200 
date: Tue, 20 Jan 2026 18:31:28 GMT
content-type: application/json
content-length: 308
server: cloudflare
cf-cache-status: DYNAMIC
nel: {"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}
report-to: {"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=asrBSWYY9S5ZD27BCPc216pkNzIFeSMcUFNspJxxjKTXZ55jUaHHh9Zn6PVD2L46DitnBzF6KCmnt5dcoQDMLGjtFcp5uOXd3J0W%2BxWw3EBpxfcCBA%3D%3D"}]}
cf-ray: 9c10a623ed82e9dc-MAD
alt-svc: h3=":443"; ma=86400

{"response":"Lo siento, hubo un error al procesar tu mensaje. Por favor, inténtalo de nuevo.","session_id":"sess_cache_1768933889","requires_event_selection":false,"suggested_events":[],"metadata":{"provider":"cache","model":"cached_response","response_time_ms":1,"from_cache":true,"cache_type":"greeting"}}```

## Fin smoke test
- **RequestId**: `smoke_20260120_193126_29838`
- **Reporte**: `docs/reports/BACKEND_IA_SMOKE_smoke_20260120_193126_29838.md`
