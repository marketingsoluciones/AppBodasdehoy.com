import { NextRequest, NextResponse } from 'next/server';

// Forzar uso del runtime de Node.js para poder hacer peticiones HTTP
export const runtime = 'nodejs';

/**
 * API Route: Identificar Usuario
 * Proxy al backend Python para identificar tipo de usuario (guest o registered)
 * 
 * POST /api/auth/identify-user
 * Body: { developer?: string, email?: string, phone?: string }
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { developer = 'bodasdehoy', email, phone } = body;

    console.log('üì• /api/auth/identify-user proxy recibido:', {
      developer,
      email: email ? `${email.slice(0, 10)}...` : undefined,
      hasEmail: !!email,
      hasPhone: !!phone,
      phone: phone ? `${phone.slice(0, 10)}...` : undefined,
    });

    // Proxy al backend Python en 8030
    // Usar 127.0.0.1 en lugar de localhost para evitar problemas con IPv6
    const PYTHON_BACKEND_URL = process.env.PYTHON_BACKEND_URL || 'http://127.0.0.1:8030';
    
    console.log(`üì° Haciendo proxy a: ${PYTHON_BACKEND_URL}/api/auth/identify-user`);
    
    const response = await fetch(`${PYTHON_BACKEND_URL}/api/auth/identify-user`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        developer,
        email: email || undefined,
        phone: phone || undefined,
      }),
      signal: AbortSignal.timeout(10000), // 10 segundos timeout
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error(`‚ùå Error ${response.status} del backend Python:`, errorText);
      return NextResponse.json(
        {
          success: false,
          error: `Backend error: ${response.statusText}`,
        },
        { status: response.status }
      );
    }

    const data = await response.json();
    
    console.log('‚úÖ Respuesta del backend Python:', {
      success: data.success,
      user_id: data.user_id ? `${data.user_id.slice(0, 20)}...` : undefined,
      user_type: data.user_type,
      development: data.development,
    });

    return NextResponse.json(data);
  } catch (error: any) {
    console.error('‚ùå Error en /api/auth/identify-user:', error);
    return NextResponse.json(
      {
        success: false,
        error: error.message || 'Error interno del servidor',
      },
      { status: 500 }
    );
  }
}

    // ‚úÖ CORRECCI√ìN: Usar queries que realmente existen en api2
    // Con paginaci√≥n requerida y estructura de respuesta correcta
    const query = email ? `
      query GetUserEvents($identifier: String!, $development: String!, $pagination: CRM_PaginationInput!) {
        getAllUserRelatedEventsByEmail(email: $identifier, development: $development, pagination: $pagination) {
          success
          eventos {
            id
            nombre
            fecha
            tipo
            estatus
            usuario_id
            usuario_nombre
            createdAt
            updatedAt
          }
          total
          errors {
            message
            code
          }
        }
      }
    ` : `
      query GetUserEvents($identifier: String!, $development: String!, $pagination: CRM_PaginationInput!) {
        getAllUserRelatedEventsByPhone(phoneNumber: $identifier, development: $development, pagination: $pagination) {
          success
          eventos {
            id
            nombre
            fecha
            tipo
            estatus
            usuario_id
            usuario_nombre
            createdAt
            updatedAt
          }
          total
          errors {
            message
            code
          }
        }
      }
    `;

    // Intentar m√∫ltiples developments si el email parece ser de otra marca
    // Ejemplo: carlos.carrillo@recargaexpress.com ‚Üí intentar 'recargaexpress' tambi√©n
    const possibleDevelopments = [development];
    if (email && email.includes('@')) {
      const emailDomain = email.split('@')[1]?.split('.')[0];
      if (emailDomain && emailDomain !== development && emailDomain.length > 2) {
        possibleDevelopments.push(emailDomain);
        console.log(`üí° Intentando tambi√©n con development del dominio: ${emailDomain}`);
      }
    }

    // Intentar con cada development posible
    for (const dev of possibleDevelopments) {
      const identifier = email ?? phone;
      if (!identifier) {
        continue;
      }
      const variables: Record<string, any> = {
        development: dev,
        identifier,
        pagination: { limit: 10, page: 1 }
      };

      console.log(`üì§ Query GraphQL (development: ${dev}):`, {
        development: dev,
        identifier: identifier ? `${identifier.slice(0, 5)}...` : undefined,
        isEmail: !!email
      });

      // Usar middleware Python en lugar de llamar directamente a api2
      // El middleware maneja CORS, SSL y hace proxy a api2
      // En rutas API del servidor, usar directamente el dominio p√∫blico del middleware
      const graphqlUrl = process.env.GRAPHQL_ENDPOINT ||
                         (process.env.BACKEND_URL
                           ? `${process.env.BACKEND_URL}/graphql`
                           : process.env.API2_GRAPHQL_URL || 'https://api2.eventosorganizador.com/graphql');

      try {
        const response = await fetch(graphqlUrl, {
          body: JSON.stringify({ query, variables }),
          headers: {
            'Content-Type': 'application/json',
            Origin: 'https://eventosorganizador.com',
          },
          method: 'POST',
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error(`‚ùå Error GraphQL HTTP ${response.status} (dev: ${dev}):`, errorText);
          continue; // Intentar siguiente development
        }

        const result = await response.json();

        if (result.errors) {
          console.warn(`‚ö†Ô∏è Errores GraphQL (dev: ${dev}):`, result.errors);
          continue; // Intentar siguiente development
        }

        // ‚úÖ CORRECCI√ìN: Leer desde la query correcta con nueva estructura
        const eventsKey = email ? 'getAllUserRelatedEventsByEmail' : 'getAllUserRelatedEventsByPhone';
        const eventsResponse = result.data?.[eventsKey];
        const events = eventsResponse?.eventos || [];

        if (eventsResponse?.success && events && events.length > 0) {
          // Usuario encontrado (tiene eventos)
          const firstEvent = events[0];
          // ‚úÖ CORRECCI√ìN: Construir userData con email/phone prioritarios
          // Priorizar email/phone del par√°metro, luego del evento
          const identifierIsEmail = identifier.includes('@');
          const finalEmail =
            email || firstEvent.usuario_email || (identifierIsEmail ? identifier : undefined);
          const finalPhone =
            phone ||
            firstEvent.usuario_telefono ||
            (!identifierIsEmail ? identifier : undefined);

          const userData = {
            _id: firstEvent.usuario_id || identifier,
            development: dev,
            displayName:
              firstEvent.usuario_nombre ||
              (identifierIsEmail ? identifier.split('@')[0] : identifier),
            email: finalEmail,
            events: events,
            nombre:
              firstEvent.usuario_nombre ||
              (identifierIsEmail ? identifier.split('@')[0] : identifier),
            phoneNumber: finalPhone,
            telefono: finalPhone  // Incluir eventos para contexto
          };

          console.log(`‚úÖ Usuario encontrado en GraphQL con development: ${dev}`, {
            _id: userData._id,
            development: dev,
            email: userData.email?.slice(0, 5) + '...',
            events_count: events.length,
            phone: userData.telefono?.slice(0, 5) + '...'
          });
          return userData;
        }
      } catch (err: any) {
        console.warn(`‚ö†Ô∏è Error consultando GraphQL con development ${dev}:`, err.message);
        continue; // Intentar siguiente development
      }
    }

    // Si llegamos aqu√≠, no se encontr√≥ en ning√∫n development
    console.log('‚ÑπÔ∏è Usuario no encontrado en GraphQL con ning√∫n development probado:', possibleDevelopments);
    return null;
}

/**
 * API Route para identificar usuario (login simple)
 * Reemplaza al backend Python
 * POST /api/auth/identify-user
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { developer = 'bodasdehoy', email, phone } = body;

    console.log('üì• Request identify-user recibido:', {
      developer,
      email: email ? `${email.slice(0, 10)}...` : undefined,
      hasEmail: !!email,
      hasPhone: !!phone,
      phone: phone ? `${phone.slice(0, 10)}...` : undefined
    });

    // Si no hay email ni tel√©fono, es usuario visitante
    if (!email && !phone) {
      console.log('‚ÑπÔ∏è Sin email ni tel√©fono, retornando usuario visitante');
      return NextResponse.json({
        development: developer,
        role: 'guest',
        success: true,
        user_id: 'visitante@guest.local',
        user_type: 'guest',
      });
    }

    // Intentar obtener usuario de GraphQL
    const user_data = await getUserByEmailOrPhone(
      email || undefined,
      phone || undefined,
      developer
    );

    if (user_data) {
      // Usuario registrado encontrado
      const user_id =
        user_data.email ||
        user_data.telefono ||
        user_data.phoneNumber ||
        email ||
        phone;

      console.log('‚úÖ Usuario registrado identificado:', {
        user_id: user_id.slice(0, 20) + '...',
        user_type: 'registered'
      });

      return NextResponse.json({
        development: developer,
        role: 'creator', // O detectar rol seg√∫n eventos
        success: true,
        user_data: {
          _id: user_data._id,
          displayName: user_data.displayName || user_data.nombre,
          email: user_data.email,
          phone: user_data.telefono || user_data.phoneNumber,
        },
        user_id,
        user_type: 'registered',
      });
    } else {
      // Usuario no encontrado, tratar como visitante con el email/tel√©fono proporcionado
      const user_id = email || phone;

      console.log('‚ÑπÔ∏è Usuario no encontrado en BD, tratando como visitante:', {
        user_id: user_id.slice(0, 20) + '...',
        user_type: 'guest'
      });

      return NextResponse.json({
        development: developer,
        role: 'guest',
        success: true,
        user_id,
        user_type: 'guest',
      });
    }
  } catch (error: any) {
    console.error('‚ùå Error en identify-user:', {
      message: error.message,
      name: error.name,
      stack: error.stack
    });
    return NextResponse.json(
      {
        error: error.message || 'Error al identificar usuario',
        success: false,
      },
      { status: 500 }
    );
  }
}

