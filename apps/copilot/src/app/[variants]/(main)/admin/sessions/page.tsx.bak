'use client';

import { useCallback, useEffect, useMemo, useState } from 'react';

interface Session {
  duration: number;
  id: string;
  lastActivity: string;
  messagesCount: number;
  model: string;
  provider: string;
  status: 'active' | 'idle' | 'closed';
  userEmail: string;
  userId: string;
  userName: string;
}

const formatDuration = (seconds: number) => {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  if (hours > 0) return `${hours}h ${minutes}m`;
  return `${minutes}m`;
};

const formatLastActivity = (timestamp: string) => {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffMins = Math.floor(diffMs / 60_000);
  const diffHours = Math.floor(diffMs / 3_600_000);

  if (diffMins < 1) return 'Ahora';
  if (diffMins < 60) return `Hace ${diffMins}m`;
  if (diffHours < 24) return `Hace ${diffHours}h`;
  return date.toLocaleString('es-ES', {
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    month: '2-digit',
  });
};

export default function SessionsPage() {
  const [sessions, setSessions] = useState<Session[]>([]);
  const [loading, setLoading] = useState(true);
  const [selectedStatus, setSelectedStatus] = useState<string>('');

  const fetchSessions = useCallback(async () => {
    try {
      setLoading(true);

      // TODO: Implementar fetch real desde backend
      // const response = await fetch('http://localhost:8030/api/admin/sessions?development=bodasdehoy');

      // Datos de ejemplo
      const mockSessions: Session[] = [
        {
          duration: 1200,
          id: 'session_1',
          lastActivity: new Date(Date.now() - 2 * 60 * 1000).toISOString(),
          messagesCount: 15,
          model: 'claude-3-opus',
          provider: 'anthropic',
          status: 'active',
          userEmail: 'juan@example.com',
          userId: 'user_1',
          userName: 'Juan P√©rez',
        },
        {
          duration: 600,
          id: 'session_2',
          lastActivity: new Date(Date.now() - 15 * 60 * 1000).toISOString(),
          messagesCount: 8,
          model: 'gpt-4o',
          provider: 'openai',
          status: 'idle',
          userEmail: 'maria@example.com',
          userId: 'user_2',
          userName: 'Mar√≠a Garc√≠a',
        },
        {
          duration: 3600,
          id: 'session_3',
          lastActivity: new Date(Date.now() - 60 * 60 * 1000).toISOString(),
          messagesCount: 25,
          model: 'gemini-1.5-flash',
          provider: 'gemini',
          status: 'closed',
          userEmail: 'carlos@example.com',
          userId: 'user_3',
          userName: 'Carlos L√≥pez',
        },
      ];

      setSessions(mockSessions);
    } catch (error) {
      console.error('Error al cargar sesiones:', error);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchSessions();
    const interval = setInterval(fetchSessions, 30_000); // Refresh cada 30s
    return () => clearInterval(interval);
  }, [fetchSessions]);

  const filteredSessions = useMemo(
    () => (selectedStatus ? sessions.filter((s) => s.status === selectedStatus) : sessions),
    [sessions, selectedStatus]
  );

  const activeSessions = useMemo(
    () => sessions.filter((s) => s.status === 'active'),
    [sessions]
  );

  const totalMessages = useMemo(
    () => sessions.reduce((sum, s) => sum + s.messagesCount, 0),
    [sessions]
  );

  const avgDuration = useMemo(
    () =>
      sessions.length > 0 ? sessions.reduce((sum, s) => sum + s.duration, 0) / sessions.length : 0,
    [sessions]
  );

  const handleTerminateSession = useCallback((sessionId: string) => {
    if (confirm('¬øEst√°s seguro de terminar esta sesi√≥n?')) {
      setSessions((prev) =>
        prev.map((s) => (s.id === sessionId ? { ...s, status: 'closed' as const } : s))
      );
    }
  }, []);

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">üîê Sesiones Activas</h1>
          <p className="mt-2 text-gray-600">Monitoreo en tiempo real de sesiones de usuario</p>
        </div>
        <button
          className="rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50"
          onClick={() => fetchSessions()}
          type="button"
        >
          üîÑ Actualizar
        </button>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 gap-4 md:grid-cols-4">
        <div className="rounded-lg border border-gray-200 bg-white p-4">
          <div className="text-sm text-gray-600">Total Sesiones</div>
          <div className="mt-1 text-2xl font-bold text-gray-900">{sessions.length}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-gradient-to-br from-green-50 to-green-100 p-4">
          <div className="text-sm text-gray-600">Activas</div>
          <div className="mt-1 text-2xl font-bold text-green-700">{activeSessions.length}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-gradient-to-br from-blue-50 to-blue-100 p-4">
          <div className="text-sm text-gray-600">Mensajes Total</div>
          <div className="mt-1 text-2xl font-bold text-blue-700">{totalMessages}</div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-gradient-to-br from-purple-50 to-purple-100 p-4">
          <div className="text-sm text-gray-600">Duraci√≥n Promedio</div>
          <div className="mt-1 text-2xl font-bold text-purple-700">
            {formatDuration(avgDuration)}
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="flex gap-4 rounded-lg border border-gray-200 bg-white p-4">
        <button
          className={`rounded-lg px-4 py-2 text-sm font-medium transition-colors ${
            selectedStatus === '' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
          onClick={() => setSelectedStatus('')}
          type="button"
        >
          Todas ({sessions.length})
        </button>
        <button
          className={`rounded-lg px-4 py-2 text-sm font-medium transition-colors ${
            selectedStatus === 'active' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
          onClick={() => setSelectedStatus('active')}
          type="button"
        >
          üü¢ Activas ({activeSessions.length})
        </button>
        <button
          className={`rounded-lg px-4 py-2 text-sm font-medium transition-colors ${
            selectedStatus === 'idle' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
          onClick={() => setSelectedStatus('idle')}
          type="button"
        >
          üü° Inactivas ({sessions.filter((s) => s.status === 'idle').length})
        </button>
        <button
          className={`rounded-lg px-4 py-2 text-sm font-medium transition-colors ${
            selectedStatus === 'closed' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
          }`}
          onClick={() => setSelectedStatus('closed')}
          type="button"
        >
          ‚ö´ Cerradas ({sessions.filter((s) => s.status === 'closed').length})
        </button>
      </div>

      {/* Sessions Table */}
      {loading ? (
        <div className="rounded-lg border border-gray-200 bg-white p-8 text-center text-gray-500">
          Cargando sesiones...
        </div>
      ) : (
        <div className="overflow-x-auto rounded-lg border border-gray-200 bg-white">
          <table className="w-full text-left text-sm">
            <thead className="bg-gray-50 text-xs uppercase text-gray-700">
              <tr>
                <th className="px-4 py-3">ID Sesi√≥n</th>
                <th className="px-4 py-3">Usuario</th>
                <th className="px-4 py-3">Modelo</th>
                <th className="px-4 py-3 text-center">Mensajes</th>
                <th className="px-4 py-3 text-center">Duraci√≥n</th>
                <th className="px-4 py-3">√öltima Actividad</th>
                <th className="px-4 py-3">Estado</th>
                <th className="px-4 py-3 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {filteredSessions.map((session) => (
                <tr className="border-b hover:bg-gray-50" key={session.id}>
                  <td className="px-4 py-3">
                    <code className="rounded bg-gray-100 px-2 py-1 text-xs text-gray-700">
                      {session.id}
                    </code>
                  </td>
                  <td className="px-4 py-3">
                    <div>
                      <div className="font-medium text-gray-900">{session.userName}</div>
                      <div className="text-xs text-gray-500">{session.userEmail}</div>
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <div>
                      <div className="font-medium text-gray-900">{session.model}</div>
                      <div className="text-xs text-gray-500">{session.provider}</div>
                    </div>
                  </td>
                  <td className="px-4 py-3 text-center font-semibold text-gray-900">
                    {session.messagesCount}
                  </td>
                  <td className="px-4 py-3 text-center text-gray-600">
                    {formatDuration(session.duration)}
                  </td>
                  <td className="px-4 py-3 text-gray-600">
                    {formatLastActivity(session.lastActivity)}
                  </td>
                  <td className="px-4 py-3">
                    {session.status === 'active' && (
                      <span className="rounded-full bg-green-100 px-2 py-1 text-xs font-medium text-green-700">
                        üü¢ Activa
                      </span>
                    )}
                    {session.status === 'idle' && (
                      <span className="rounded-full bg-yellow-100 px-2 py-1 text-xs font-medium text-yellow-700">
                        üü° Inactiva
                      </span>
                    )}
                    {session.status === 'closed' && (
                      <span className="rounded-full bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700">
                        ‚ö´ Cerrada
                      </span>
                    )}
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex justify-end gap-2">
                      {session.status !== 'closed' && (
                        <button
                          className="rounded-lg border border-red-300 px-2 py-1 text-xs text-red-600 hover:bg-red-50"
                          onClick={() => handleTerminateSession(session.id)}
                          type="button"
                        >
                          ‚èπÔ∏è Terminar
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          {filteredSessions.length === 0 && (
            <div className="p-8 text-center text-gray-500">
              No se encontraron sesiones con el filtro aplicado
            </div>
          )}
        </div>
      )}
    </div>
  );
}

  const filteredSessions = selectedStatus
    ? sessions.filter((s) => s.status === selectedStatus)
    : sessions;

  const activeSessions = sessions.filter((s) => s.status === 'active');
  const totalMessages = sessions.reduce((sum, s) => sum + s.messagesCount, 0);
  const avgDuration = sessions.length > 0
    ? sessions.reduce((sum, s) => sum + s.duration, 0) / sessions.length
    : 0;

  const formatDuration = (seconds: number) => {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    if (hours > 0) return `${hours}h ${minutes}m`;
    return `${minutes}m`;
  };

  const formatLastActivity = (timestamp: string) => {
    const date = new Date(timestamp);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60_000);
    const diffHours = Math.floor(diffMs / 3_600_000);

    if (diffMins < 1) return 'Ahora';
    if (diffMins < 60) return `Hace ${diffMins}m`;
    if (diffHours < 24) return `Hace ${diffHours}h`;
    return date.toLocaleString('es-ES', {
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      month: '2-digit',
    });
  };

  const getStatusBadge = (status: string) => {
    const configs: Record<string, { color: string; icon: string, label: string; }> = {
      active: { color: 'bg-green-100 text-green-700', icon: 'üü¢', label: 'Activa' },
      closed: { color: 'bg-gray-100 text-gray-700', icon: '‚ö™', label: 'Cerrada' },
      idle: { color: 'bg-yellow-100 text-yellow-700', icon: 'üü°', label: 'Inactiva' },
    };
    const config = configs[status] || { color: 'bg-gray-100 text-gray-700', icon: '‚ö™', label: status };
    return (
      <span className={`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${config.color}`}>
        <span>{config.icon}</span>
        {config.label}
      </span>
    );
  };

  const handleCloseSession = async (sessionId: string) => {
    if (!confirm('¬øEst√°s seguro de que deseas cerrar esta sesi√≥n?')) return;
    
    try {
      // TODO: Implementar cierre real
      // await fetch(`http://localhost:8030/api/admin/sessions/${sessionId}`, { method: 'DELETE' });
      
      setSessions(sessions.map(s =>
        s.id === sessionId ? { ...s, status: 'closed' as const } : s
      ));
      alert('Sesi√≥n cerrada exitosamente');
    } catch (error) {
      console.error('Error al cerrar sesi√≥n:', error);
      alert('Error al cerrar sesi√≥n');
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-3xl font-bold">üîê Gesti√≥n de Sesiones</h1>
        <p className="mt-2 text-gray-600">
          Monitorea sesiones activas y su actividad en tiempo real
        </p>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 gap-4 md:grid-cols-4">
        <div className="rounded-lg border border-gray-200 bg-gradient-to-br from-green-50 to-green-100 p-4">
          <div className="text-sm text-gray-600">Sesiones Activas</div>
          <div className="mt-2 text-3xl font-bold text-green-700">
            {activeSessions.length}
          </div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-gradient-to-br from-blue-50 to-blue-100 p-4">
          <div className="text-sm text-gray-600">Total Sesiones</div>
          <div className="mt-2 text-3xl font-bold text-blue-700">
            {sessions.length}
          </div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-gradient-to-br from-purple-50 to-purple-100 p-4">
          <div className="text-sm text-gray-600">Total Mensajes</div>
          <div className="mt-2 text-3xl font-bold text-purple-700">
            {totalMessages}
          </div>
        </div>
        <div className="rounded-lg border border-gray-200 bg-gradient-to-br from-orange-50 to-orange-100 p-4">
          <div className="text-sm text-gray-600">Duraci√≥n Promedio</div>
          <div className="mt-2 text-3xl font-bold text-orange-700">
            {formatDuration(avgDuration)}
          </div>
        </div>
      </div>

      {/* Filters */}
      <div className="rounded-lg border border-gray-200 bg-white p-4">
        <div className="flex gap-4">
          <select
            className="rounded-lg border border-gray-300 px-4 py-2 text-sm focus:border-blue-500 focus:outline-none"
            onChange={(e) => setSelectedStatus(e.target.value)}
            value={selectedStatus}
          >
            <option value="">Todos los estados</option>
            <option value="active">Activas</option>
            <option value="idle">Inactivas</option>
            <option value="closed">Cerradas</option>
          </select>
          <button
            className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700"
            onClick={fetchSessions}
          >
            üîÑ Actualizar
          </button>
        </div>
      </div>

      {/* Sessions Table */}
      <div className="rounded-lg border border-gray-200 bg-white">
        <div className="overflow-x-auto">
          <table className="w-full text-left text-sm">
            <thead className="bg-gray-50 text-xs uppercase text-gray-700">
              <tr>
                <th className="px-6 py-3">Usuario</th>
                <th className="px-6 py-3">Provider / Modelo</th>
                <th className="px-6 py-3 text-right">Mensajes</th>
                <th className="px-6 py-3 text-right">Duraci√≥n</th>
                <th className="px-6 py-3">√öltima Actividad</th>
                <th className="px-6 py-3">Estado</th>
                <th className="px-6 py-3 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {loading ? (
                <tr>
                  <td className="px-6 py-8 text-center text-gray-500" colSpan={7}>
                    Cargando sesiones...
                  </td>
                </tr>
              ) : filteredSessions.length === 0 ? (
                <tr>
                  <td className="px-6 py-8 text-center text-gray-500" colSpan={7}>
                    No se encontraron sesiones
                  </td>
                </tr>
              ) : (
                filteredSessions.map((session) => (
                  <tr className="hover:bg-gray-50" key={session.id}>
                    <td className="px-6 py-4">
                      <div>
                        <div className="font-medium text-gray-900">{session.userName}</div>
                        <div className="text-xs text-gray-500">{session.userEmail}</div>
                        <div className="mt-0.5 text-xs text-gray-400">ID: {session.id}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4">
                      <div>
                        <div className="font-medium text-gray-700">{session.provider}</div>
                        <div className="text-xs text-gray-500">{session.model}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4 text-right font-semibold text-gray-700">
                      {session.messagesCount}
                    </td>
                    <td className="px-6 py-4 text-right text-gray-600">
                      {formatDuration(session.duration)}
                    </td>
                    <td className="px-6 py-4 text-gray-600">
                      {formatLastActivity(session.lastActivity)}
                    </td>
                    <td className="px-6 py-4">{getStatusBadge(session.status)}</td>
                    <td className="px-6 py-4 text-right">
                      <div className="flex justify-end gap-2">
                        <button
                          className="text-blue-600 hover:text-blue-800"
                          title="Ver chat"
                        >
                          üí¨
                        </button>
                        {session.status !== 'closed' && (
                          <button
                            className="text-red-600 hover:text-red-800"
                            onClick={() => handleCloseSession(session.id)}
                            title="Cerrar sesi√≥n"
                          >
                            ‚äó
                          </button>
                        )}
                      </div>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Auto-refresh indicator */}
      <div className="text-center text-xs text-gray-500">
        üîÑ Actualizaci√≥n autom√°tica cada 30 segundos
      </div>
    </div>
  );
}

